<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Settings - Environment</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-50 text-slate-900">
    <div class="max-w-6xl mx-auto p-6 space-y-6">
      <section class="bg-white rounded shadow p-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div>
            <h1 class="text-xl font-semibold">Server Controls</h1>
            <p class="text-sm text-slate-600">Development-only utilities</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnRestartTop" class="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700">Restart Server</button>
            <a class="text-blue-600 hover:underline text-sm" href="/api/v1/health" target="_blank" rel="noreferrer">Health</a>
          </div>
        </div>
      </section>

      <section class="bg-white rounded shadow p-4">
        <div class="font-semibold mb-2">Server Info</div>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div>PID: <span id="sv-pid">—</span></div>
          <div>Uptime: <span id="sv-uptime">—</span></div>
          <div>Started: <span id="sv-start">—</span></div>
          <div>Current: <span id="sv-now">—</span></div>
          <div class="col-span-2">Last Restart: <span id="sv-last-restart">—</span></div>
        </div>
      </section>

      <header class="flex items-center justify-between">
        <h1 class="text-2xl font-semibold">Settings</h1>
        <nav class="flex items-center gap-4 text-sm">
          <a class="text-blue-600 hover:underline" href="/">Home</a>
        </nav>
      </header>

      <section class="bg-white rounded shadow p-4 space-y-3">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div>
            <h2 class="text-lg font-medium">Environment Variables</h2>
            <p class="text-sm text-slate-600">Source: {{ source }}</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnRestart" class="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700">Restart Server</button>
            <input id="filterBox" type="text" placeholder="Filter by key..." class="border rounded px-3 py-2" />
          </div>
        </div>

        {% if fallback_used %}
          <div class="text-sm text-amber-800 bg-amber-50 border border-amber-200 rounded p-2">
            .env file not found. Displaying a limited subset from process environment.
          </div>
        {% endif %}

        <div class="overflow-auto rounded border">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 text-slate-700">
              <tr>
                <th class="text-left px-3 py-2 font-medium">Key</th>
                <th class="text-left px-3 py-2 font-medium">Value</th>
                <th class="text-left px-3 py-2 font-medium">Actions</th>
              </tr>
            </thead>
            <tbody id="envTable" class="divide-y">
              {% for e in entries %}
              <tr data-key="{{ e.key }}">
                <td class="px-3 py-2 align-top whitespace-nowrap font-mono text-slate-800">
                  {{ e.key }}
                  {% if e.is_sensitive %}
                    <span class="ml-2 text-[10px] uppercase tracking-wide bg-rose-100 text-rose-700 rounded px-1 py-0.5">sensitive</span>
                  {% endif %}
                </td>
                <td class="px-3 py-2 align-top">
                  <div class="font-mono text-slate-800 break-all" data-real="{{ e.value }}" data-masked="{{ e.masked }}" data-state="masked"></div>
                </td>
                <td class="px-3 py-2 align-top">
                  <div class="flex items-center gap-2">
                    <button class="btn-toggle px-2 py-1 text-xs rounded bg-slate-200 text-slate-800">Show</button>
                    <button class="btn-copy px-2 py-1 text-xs rounded bg-slate-700 text-white">Copy</button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <script>
      (function init(){
        const showBanner = (msg, type) => {
          let el = document.getElementById('statusBanner');
          if (!el){
            el = document.createElement('div');
            el.id = 'statusBanner';
            el.className = 'fixed top-3 left-1/2 -translate-x-1/2 px-4 py-2 rounded shadow';
            document.body.appendChild(el);
          }
          const color = type === 'error' ? 'bg-rose-100 text-rose-800 border border-rose-200' : (type === 'success' ? 'bg-emerald-100 text-emerald-800 border border-emerald-200' : 'bg-sky-100 text-sky-800 border border-sky-200');
          el.className = 'fixed top-3 left-1/2 -translate-x-1/2 px-4 py-2 rounded shadow ' + color;
          el.textContent = msg;
          el.style.display = '';
        };
        const hideBanner = () => {
          const el = document.getElementById('statusBanner');
          if (el){ el.style.display = 'none'; }
        };

        const table = document.getElementById('envTable');
        // initialize masked values
        table.querySelectorAll('tr').forEach(row => {
          const valueCell = row.querySelector('td:nth-child(2) div');
          if (valueCell){ valueCell.textContent = valueCell.getAttribute('data-masked') || ''; }
        });
        // toggle show/hide
        table.addEventListener('click', (e) => {
          const btn = e.target.closest('.btn-toggle');
          if (!btn) return;
          const row = btn.closest('tr');
          const valueCell = row.querySelector('td:nth-child(2) div');
          const state = valueCell.getAttribute('data-state') || 'masked';
          if (state === 'masked'){
            valueCell.textContent = valueCell.getAttribute('data-real') || '';
            valueCell.setAttribute('data-state', 'shown');
            btn.textContent = 'Hide';
          } else {
            valueCell.textContent = valueCell.getAttribute('data-masked') || '';
            valueCell.setAttribute('data-state', 'masked');
            btn.textContent = 'Show';
          }
        });
        // copy
        table.addEventListener('click', async (e) => {
          const btn = e.target.closest('.btn-copy');
          if (!btn) return;
          const row = btn.closest('tr');
          const valueCell = row.querySelector('td:nth-child(2) div');
          const value = valueCell.getAttribute('data-real') || '';
          try {
            await navigator.clipboard.writeText(value);
            btn.textContent = 'Copied';
            setTimeout(() => { btn.textContent = 'Copy'; }, 1200);
          } catch {
            btn.textContent = 'Failed';
            setTimeout(() => { btn.textContent = 'Copy'; }, 1200);
          }
        });
        // filter
        const filterBox = document.getElementById('filterBox');
        filterBox.addEventListener('input', () => {
          const q = (filterBox.value || '').toLowerCase();
          table.querySelectorAll('tr').forEach(row => {
            const k = (row.getAttribute('data-key') || '').toLowerCase();
            row.style.display = (!q || k.includes(q)) ? '' : 'none';
          });
        });

        // restart buttons
        async function doRestart(){
          if (!confirm('Restart the server now?')) return;
          showBanner('Restarting server...', 'info');
          try {
            // capture current pid
            let oldPid = null;
            try {
              const h = await fetch('/api/v1/health', { cache: 'no-store' }).then(r=>r.json());
              oldPid = h && h.data && h.data.pid ? Number(h.data.pid) : null;
            } catch {}

            const resp = await fetch('/api/v1/settings/restart', { method: 'POST' });
            if (!resp.ok){
              const t = await resp.text();
              showBanner('Failed to restart: ' + String(t||resp.status), 'error');
              return;
            }
            const jr = await resp.json();
            const opId = jr && jr.data && jr.data.op_id ? String(jr.data.op_id) : '';
            if (opId){ try { localStorage.setItem('lastRestartOpId', opId); } catch {} }
            
            const deadline = Date.now() + 45000;
            // wait for DOWN
            const waitDown = async () => {
              while (Date.now() < deadline) {
                try { const r = await fetch('/api/v1/health', { cache: 'no-store' }); if (!r.ok) break; } catch { break; }
                await new Promise(rs=>setTimeout(rs, 600));
              }
            };
            await waitDown();

            // wait for UP with pid change if possible
            const waitUp = async () => {
              while (Date.now() < deadline) {
                if (opId){
                  try {
                    const s = await fetch('/api/v1/settings/restart/status/' + opId, { cache: 'no-store' }).then(r=>r.json());
                    if (s && s.data && s.data.status === 'restarted'){
                      const pb = (s.data.pid_before != null) ? String(s.data.pid_before) : '';
                      const pa = (s.data.pid_after != null) ? String(s.data.pid_after) : '';
                      const hint = (pb && pa) ? ` (PID ${pb}\u2192${pa})` : '';
                      showBanner('Server restarted' + hint + '. Reloading...', 'success');
                      setTimeout(()=>location.reload(), 800);
                      return true;
                    }
                    if (s && s.data && s.data.status === 'port_still_in_use'){ showBanner('Port still in use. Check logs.', 'error'); return false; }
                  } catch {}
                }
                try {
                  const r = await fetch('/api/v1/health', { cache: 'no-store' });
                  if (r.ok){
                    const j = await r.json();
                    const newPid = j && j.data && j.data.pid ? Number(j.data.pid) : null;
                    if (!oldPid || (newPid && newPid !== oldPid)){
                      const hint = (oldPid && newPid) ? ` (PID ${oldPid}\u2192${newPid})` : '';
                      showBanner('Server restarted' + hint + '. Reloading...', 'success');
                      setTimeout(()=>location.reload(), 800);
                      return true;
                    }
                  }
                } catch {}
                await new Promise(rs=>setTimeout(rs, 1000));
              }
              return false;
            };
            const up = await waitUp();
            if (!up){ showBanner('Server did not come back in time. Check logs.', 'error'); return; }
            showBanner('Server restarted successfully. Reloading...', 'success');
            setTimeout(() => { window.location.reload(); }, 800);
          } catch (e){
            showBanner('Error: ' + String(e), 'error');
          }
        }
        const btnRestart = document.getElementById('btnRestart');
        if (btnRestart){ btnRestart.addEventListener('click', doRestart); }
        const btnRestartTop = document.getElementById('btnRestartTop');
        if (btnRestartTop){ btnRestartTop.addEventListener('click', doRestart); }

        // Load server info
        (async function loadServerInfo(){
          try {
            const r = await fetch('/api/v1/health', { cache: 'no-store' });
            if (!r.ok) return;
            const j = await r.json();
            const d = j && j.data ? j.data : {};
            const pidEl = document.getElementById('sv-pid'); if (pidEl) pidEl.textContent = (d.pid != null ? String(d.pid) : '—');
            const stEl = document.getElementById('sv-start');
            const nowEl = document.getElementById('sv-now');
            const upEl = document.getElementById('sv-uptime');
            const lrEl = document.getElementById('sv-last-restart');
            const fmt = (iso) => {
              if (!iso) return '—';
              try {
                const dt = new Date(iso);
                const mm = String(dt.getUTCMonth()+1).padStart(2,'0');
                const dd = String(dt.getUTCDate()).padStart(2,'0');
                const HH = String(dt.getUTCHours()).padStart(2,'0');
                const MM = String(dt.getUTCMinutes()).padStart(2,'0');
                const SS = String(dt.getUTCSeconds()).padStart(2,'0');
                return `${mm}-${dd} ${HH}:${MM}:${SS}`;
              } catch { return String(iso); }
            };
            // Initial values and ticker
            const startedIso = d.started || null;
            if (stEl) stEl.textContent = fmt(startedIso);
            (function startTicker(){
              const startedTs = startedIso ? Date.parse(startedIso) : null;
              function formatNow(ts){
                const dt = new Date(ts);
                const mm = String(dt.getUTCMonth()+1).padStart(2,'0');
                const dd = String(dt.getUTCDate()).padStart(2,'0');
                const HH = String(dt.getUTCHours()).padStart(2,'0');
                const MM = String(dt.getUTCMinutes()).padStart(2,'0');
                const SS = String(dt.getUTCSeconds()).padStart(2,'0');
                return `${mm}-${dd} ${HH}:${MM}:${SS}`;
              }
              function tick(){
                const nowTs = Date.now();
                if (nowEl) nowEl.textContent = formatNow(nowTs);
                if (upEl){
                  if (startedTs){
                    const s = Math.max(0, Math.floor((nowTs - startedTs)/1000));
                    const days = Math.floor(s/86400);
                    const h = Math.floor((s%86400)/3600).toString().padStart(2,'0');
                    const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
                    const sec = Math.floor(s%60).toString().padStart(2,'0');
                    upEl.textContent = `${days} days, ${h}:${m}:${sec}`;
                  } else {
                    upEl.textContent = '—';
                  }
                }
              }
              tick();
              setInterval(tick, 1000);
            })();
            try {
              const opId = localStorage.getItem('lastRestartOpId') || '';
              if (opId && lrEl){
                const s = await fetch('/api/v1/settings/restart/status/' + opId, { cache: 'no-store' }).then(r=>r.json()).catch(()=>null);
                const data = s && s.data;
                if (data && data.status === 'restarted' && (data.pid_before!=null || data.pid_after!=null)){
                  const pb = data.pid_before!=null ? String(data.pid_before) : '';
                  const pa = data.pid_after!=null ? String(data.pid_after) : '';
                  lrEl.textContent = (pb && pa) ? `PID ${pb}→${pa}` : '—';
                }
              }
            } catch {}
          } catch {}
        })();
      })();
    </script>
  </body>
  </html>


